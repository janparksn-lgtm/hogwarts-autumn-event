<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ü–µ—Ä—Å–æ–Ω–∞ ‚Äî –æ—Å–µ–Ω—å (–≤—ã–±–æ—Ä—ã + –º–∞–≥–∏—è + –ø–ª–µ–π–ª–∏—Å—Ç)</title>
<style>
  :root{
    --bg:#1b1726; 
    --card:#261e36; 
    --ink:#f7f2e8;
    --muted:#000000;
    --line:#3a2f4d;
    --accent:#6d28d9;      /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
    --accent2:#d4a017;     /* –∑–æ–ª–æ—Ç–æ–π */
    --base-font:12px;      /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ */
  }

  /* –ü–∞–ª–∏—Ç—Ä—ã —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–æ–≤ */
  .gryff{ --bg:#2b0a0a; --card:#3a1212; --line:#5a1b1b; --ink:#f7f2e8; }
  .rav  { --bg:#0b132b; --card:#14213d; --line:#1f2a44; --ink:#f7f2e8; }
  .huff { --bg:#1f1a0a; --card:#2a2412; --line:#3b3217; --ink:#f7f2e8; }
  .sly  { --bg:#0d1f17; --card:#123425; --line:#1b4030; --ink:#f7f2e8; }

  body{
    margin:0;
    background: radial-gradient(1100px 760px at 12% -8%, #2a223e 0%, var(--bg) 60%);
    color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  }

  .wrap{ max-width:1120px; margin:24px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 400px 1fr; }
  @media (max-width:1000px){ .wrap{ grid-template-columns:1fr } }

  /* –ü–∞–Ω–µ–ª—å —Ñ–æ—Ä–º—ã */
  .panel{ background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:16px; padding:14px; }
  .panel h2{ margin:0 0 10px; font-size:18px }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px }
  .field label{ font-size:12px; color:var(--muted) }
  .field input[type="text"], .field input[type="url"], .field input[type="number"], .field select{
    background:#14111e; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px;
  }
  .hint{ font-size:11px; color:#a1a1a1 }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--ink); border-radius:12px; padding:10px 12px; font-weight:600; }
  .btn.primary{ background:linear-gradient(180deg, var(--accent), var(--accent2)); color:#1a1325; border:none }
  .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .warn{ font-size:12px; color:#ffd18a; background:rgba(212,160,23,.12); border:1px solid rgba(212,160,23,.35); padding:8px 10px; border-radius:10px; display:none }

  /* –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–æ—á–∫–∏ */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    font-size: var(--base-font);
    color: var(--ink);
  }
  .ap-head{
    display:grid; grid-template-columns: 90px 1fr; gap:12px; align-items:center;
    padding:12px; border-radius:14px; border:1px solid var(--line); margin-bottom:12px;
    background: linear-gradient(100deg, rgba(109,40,217,.18), rgba(212,160,23,.10));
  }
  .ap-ava{ width:90px; height:90px; border-radius:12px; overflow:hidden; border:1px solid var(--line); box-shadow:0 6px 16px rgba(0,0,0,.25) }
  .ap-ava img{ width:100%; height:100%; object-fit:cover }
  .ap-title h2{ margin:0; font-size:18px; letter-spacing:.2px; color:var(--accent2) }
  .ap-title .sub{ margin-top:4px; color:var(--ink); opacity:.9; font-size:12px }

  .ap-grid{ display:grid; grid-template-columns: 1.05fr .95fr; gap:14px }
  @media (max-width:700px){ .ap-grid{ grid-template-columns:1fr } }

  .block-title{ margin:0 0 8px; font-size:14px; color:var(--accent2); font-weight:700 }

  /* This-or-That */
  .tt-wrap{ display:grid; gap:8px }
  .tt-item{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; border:1px solid var(--line); border-radius:12px; padding:8px; background:rgba(255,255,255,.03) }
  .tt-q{ font-weight:800; color:var(--accent); min-width:220px; font-size:12px }
  .tt-opts{ display:flex; gap:8px; flex-wrap:wrap }
  .tt-opts label{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; cursor:pointer; background:rgba(0,0,0,.08) }
  .tt-opts input{ accent-color: var(--accent2); }

  .tt-badges{ display:flex; gap:8px; flex-wrap:wrap; }
  .tt-badge{ font-size:11px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.06) }
  .tt-badge b{ color:var(--accent2) }

  .tracks{ display:grid; gap:6px; margin-top:6px }
  .track{ padding:8px; border:1px dashed var(--line); border-radius:10px; background:rgba(255,255,255,.03); font-size:12px }
  .track a{ color:var(--ink); text-decoration:none }
  .track a:hover{ color:var(--accent2) }

  .mood{ margin-top:14px }
  .mood-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
  @media (max-width:600px){ .mood-grid{ grid-template-columns:repeat(2,1fr) } }
  .mood-grid img{ width:100%; height:140px; object-fit:cover; border-radius:12px; border:1px solid var(--line) }

  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .chip{ font-size:11px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.06) }
  .chip b{ color:var(--accent2) }

  .error{ outline:1px solid #ef4444 }
</style>
</head>
<body class="">
  <div class="wrap">

    <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
    <div class="panel">
      <h2>–ó–∞–ø–æ–ª–Ω–∏ –∞–Ω–∫–µ—Ç—É</h2>

      <div class="grid-2">
        <div class="field">
          <label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
          <input type="text" id="name" value="–ò–º—è –§–∞–º–∏–ª–∏—è">
        </div>
        <div class="field">
          <label>–ù–∏–∫/—Å—Ç–∞—Ç—É—Å</label>
          <input type="text" id="status" value="@nickname ‚Ä¢ status">
        </div>

        <div class="field">
          <label>–§–∞–∫—É–ª—å—Ç–µ—Ç (–ø–∞–ª–∏—Ç—Ä–∞)</label>
          <select id="palette">
            <option value="">‚Äî –ë–∞–∑–∞ ‚Äî</option>
            <option value="gryff">–ì—Ä–∏—Ñ—Ñ–∏–Ω–¥–æ—Ä</option>
            <option value="rav">–†–µ–π–≤–µ–Ω–∫–ª–æ</option>
            <option value="huff">–•–∞—Ñ—Ñ–ª–ø–∞—Ñ—Ñ</option>
            <option value="sly">–°–ª–∏–∑–µ—Ä–∏–Ω</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>–ê–≤–∞—Ç–∞—Ä ‚Äî URL –∏–ª–∏ —Ñ–∞–π–ª (—Ñ–∞–π–ª –Ω–∞–¥—ë–∂–Ω–µ–µ)</label>
        <input type="url" id="avaUrl" placeholder="https://...">
        <input type="file" id="avaFile" accept="image/*">
      </div>

      <h3>–í—ã–±–æ—Ä-–æ—Ç–≤–µ—Ç (–æ—Å–µ–Ω–Ω–∏–π –±–ª–æ–∫)</h3>
      <div class="tt-wrap" id="tt-autumn-form">
        <div class="tt-item"><div class="tt-q">–ñ—É—Ç–∫–æ–≤–∞—Ç–∞—è –æ—Å–µ–Ω—å –∏–ª–∏ —É—é—Ç–Ω–∞—è?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta1" value="–ñ—É—Ç–∫–æ–≤–∞—Ç–∞—è –æ—Å–µ–Ω—å">–ñ—É—Ç–∫–æ–≤–∞—Ç–∞—è –æ—Å–µ–Ω—å</label>
            <label><input type="radio" name="tta1" value="–£—é—Ç–Ω–∞—è –æ—Å–µ–Ω—å">–£—é—Ç–Ω–∞—è –æ—Å–µ–Ω—å</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–¢—ã–∫–≤–µ–Ω–Ω—ã–π —Å–æ–∫ –∏–ª–∏ –≥–ª–∏–Ω—Ç–≤–µ–π–Ω?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta2" value="–¢—ã–∫–≤–µ–Ω–Ω—ã–π —Å–æ–∫">–¢—ã–∫–≤–µ–Ω–Ω—ã–π —Å–æ–∫</label>
            <label><input type="radio" name="tta2" value="–ì–ª–∏–Ω—Ç–≤–µ–π–Ω">–ì–ª–∏–Ω—Ç–≤–µ–π–Ω</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–®—É–º –¥–æ–∂–¥—è –∏–ª–∏ —Ç—Ä–µ—Å–∫ –∫–∞–º–∏–Ω–∞?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta3" value="–®—É–º –¥–æ–∂–¥—è">–®—É–º –¥–æ–∂–¥—è</label>
            <label><input type="radio" name="tta3" value="–¢—Ä–µ—Å–∫ –∫–∞–º–∏–Ω–∞">–¢—Ä–µ—Å–∫ –∫–∞–º–∏–Ω–∞</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–ó–∞–Ω–∏–º–∞—Ç—å—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –∏–ª–∏ —á–∏—Ç–∞—Ç—å –≤–æ –¥–≤–æ—Ä–µ?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta4" value="–ó–∞–Ω–∏–º–∞—Ç—å—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ">–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ</label>
            <label><input type="radio" name="tta4" value="–ß–∏—Ç–∞—Ç—å –≤–æ –¥–≤–æ—Ä–µ">–í–æ –¥–≤–æ—Ä–µ</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–í—ã—Ä–µ–∑–∞—Ç—å –∏–ª–∏ —Ä–∞—Å–∫—Ä–∞—Å–∏—Ç—å —Ç—ã–∫–≤—ã?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta5" value="–í—ã—Ä–µ–∑–∞—Ç—å —Ç—ã–∫–≤—ã">–í—ã—Ä–µ–∑–∞—Ç—å</label>
            <label><input type="radio" name="tta5" value="–†–∞—Å–∫—Ä–∞—Å–∏—Ç—å —Ç—ã–∫–≤—ã">–†–∞—Å–∫—Ä–∞—Å–∏—Ç—å</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–°–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—ã –∏–ª–∏ —Å–∏–¥–µ—Ç—å —É –∫–æ—Å—Ç—Ä–∞?</div>
          <div class="tt-opts">
            <label><input type="radio" name="tta6" value="–°–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—ã">–°–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—ã</label>
            <label><input type="radio" name="tta6" value="–°–∏–¥–µ—Ç—å —É –∫–æ—Å—Ç—Ä–∞">–£ –∫–æ—Å—Ç—Ä–∞</label>
          </div>
        </div>
      </div>

      <h3>–í—ã–±–æ—Ä-–æ—Ç–≤–µ—Ç (–º–∞–≥–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫)</h3>
      <div class="tt-wrap" id="tt-magic-form">
        <div class="tt-item"><div class="tt-q">–ú–∞–Ω—Ç–∏—è-–Ω–µ–≤–∏–¥–∏–º–∫–∞ –∏–ª–∏ –ö–∞—Ä—Ç–∞ –ú–∞—Ä–æ–¥—ë—Ä–æ–≤?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm1" value="–ú–∞–Ω—Ç–∏—è-–Ω–µ–≤–∏–¥–∏–º–∫–∞">–ú–∞–Ω—Ç–∏—è-–Ω–µ–≤–∏–¥–∏–º–∫–∞</label>
            <label><input type="radio" name="ttm1" value="–ö–∞—Ä—Ç–∞ –ú–∞—Ä–æ–¥—ë—Ä–æ–≤">–ö–∞—Ä—Ç–∞ –ú–∞—Ä–æ–¥—ë—Ä–æ–≤</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–ú–µ—Ç–ª–∞ –∏–ª–∏ –≥–∏–ø–ø–æ–≥—Ä–∏—Ñ?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm2" value="–ú–µ—Ç–ª–∞">–ú–µ—Ç–ª–∞</label>
            <label><input type="radio" name="ttm2" value="–ì–∏–ø–ø–æ–≥—Ä–∏—Ñ">–ì–∏–ø–ø–æ–≥—Ä–∏—Ñ</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–õ–µ–≤–∏—Ç–∞—Ü–∏—è –∏–ª–∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—è (–∞–ø–ø–∞—Ä–∞—Ü–∏—è)?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm3" value="–õ–µ–≤–∏—Ç–∞—Ü–∏—è">–õ–µ–≤–∏—Ç–∞—Ü–∏—è</label>
            <label><input type="radio" name="ttm3" value="–ê–ø–ø–∞—Ä–∞—Ü–∏—è">–ê–ø–ø–∞—Ä–∞—Ü–∏—è</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–§–µ–ª–∏–∫—Å –§–µ–ª–∏—Ü–∏—Å –∏–ª–∏ –û–º—É—Ç –ø–∞–º—è—Ç–∏?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm4" value="–§–µ–ª–∏–∫—Å –§–µ–ª–∏—Ü–∏—Å">–§–µ–ª–∏–∫—Å –§–µ–ª–∏—Ü–∏—Å</label>
            <label><input type="radio" name="ttm4" value="–û–º—É—Ç –ø–∞–º—è—Ç–∏">–û–º—É—Ç –ø–∞–º—è—Ç–∏</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–ü–∞—Ç—Ä–æ–Ω—É—Å –∏–ª–∏ –õ—é–º–æ—Å?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm5" value="–ü–∞—Ç—Ä–æ–Ω—É—Å">–ü–∞—Ç—Ä–æ–Ω—É—Å</label>
            <label><input type="radio" name="ttm5" value="–õ—é–º–æ—Å">–õ—é–º–æ—Å</label>
          </div>
        </div>
        <div class="tt-item"><div class="tt-q">–ó–µ–ª—å–µ–≤–∞—Ä–µ–Ω–∏–µ –∏–ª–∏ –¢—Ä–∞–Ω—Å—Ñ–∏–≥—É—Ä–∞—Ü–∏—è?</div>
          <div class="tt-opts">
            <label><input type="radio" name="ttm6" value="–ó–µ–ª—å–µ–≤–∞—Ä–µ–Ω–∏–µ">–ó–µ–ª—å–µ–≤–∞—Ä–µ–Ω–∏–µ</label>
            <label><input type="radio" name="ttm6" value="–¢—Ä–∞–Ω—Å—Ñ–∏–≥—É—Ä–∞—Ü–∏—è">–¢—Ä–∞–Ω—Å—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</label>
          </div>
        </div>
      </div>

      <h3>–ü–ª–µ–π–ª–∏—Å—Ç (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π)</h3>
      <div class="grid-2">
        <div class="field"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤ (0‚Äì12)</label><input id="tracksCount" type="number" min="0" max="12" value="3"></div>
      </div>
      <div id="tracksFields" class="grid-2"></div>

      <h3>–®–∫–æ–ª—å–Ω—ã–π moodboard</h3>
      <div class="grid-2">
        <div class="field"><label>URL 1</label><input id="m1u" placeholder="https://..."><input type="file" id="m1f" accept="image/*"></div>
        <div class="field"><label>URL 2</label><input id="m2u"><input type="file" id="m2f" accept="image/*"></div>
        <div class="field"><label>URL 3</label><input id="m3u"><input type="file" id="m3f" accept="image/*"></div>
        <div class="field"><label>URL 4</label><input id="m4u"><input type="file" id="m4f" accept="image/*"></div>
        <div class="field"><label>URL 5</label><input id="m5u"><input type="file" id="m5f" accept="image/*"></div>
        <div class="field"><label>URL 6</label><input id="m6u"><input type="file" id="m6f" accept="image/*"></div>
      </div>

      <h3>–û—Å–µ–Ω–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏</h3>
      <div class="grid-2">
        <div class="field"><label>–¶–≤–µ—Ç</label><input id="chipColor" value="–±–æ—Ä–¥–æ + –∑–æ–ª–æ—Ç–æ"></div>
        <div class="field"><label>–í–∫—É—Å</label><input id="chipTaste" value="—è–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥"></div>
        <div class="field"><label>–ó–∞–ø–∞—Ö</label><input id="chipSmell" value="–¥—ã–º, –∫–æ—Ä–∏—Ü–∞"></div>
        <div class="field"><label>–ó–≤—É–∫</label><input id="chipSound" value="–¥–æ–∂–¥—å –ø–æ —Å—Ç–µ–∫–ª—É"></div>
        <div class="field"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input id="chipItem" value="—à–µ—Ä—Å—Ç—è–Ω–æ–π —à–∞—Ä—Ñ"></div>
      </div>

      <div class="btnbar">
        <button class="btn primary" id="buildBtn">–°–æ—Å—Ç–∞–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É</button>
        <!-- –í–ê–ñ–ù–û: –±–µ–∑ disabled -->
        <button class="btn" id="pngBtn">–°–∫–∞—á–∞—Ç—å PNG</button>
      </div>
      <p class="warn" id="corsWarn">–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—Ä–æ–∏—Ç—å ‚Äî –æ–Ω–∏ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã –≤ PNG. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Ö —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞.</p>
    </div>

    <!-- –ü—Ä–µ–≤—å—é (PNG-–æ–±–ª–∞—Å—Ç—å) -->
    <div id="previewArea">
      <div id="profileCard" class="card">
        <div class="ap-head">
          <div class="ap-ava"><img id="v-ava" src="" alt="avatar"></div>
          <div class="ap-title">
            <h2 id="v-name">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
            <div class="sub" id="v-status">–ù–∏–∫/—Å—Ç–∞—Ç—É—Å</div>
          </div>
        </div>

        <div class="ap-grid">
          <div>
            <h3 class="block-title">‚öñÔ∏è –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h3>
            <div class="tt-badges" id="v-tt-autumn"></div>
            <h3 class="block-title" style="margin-top:10px">‚ú® –ß—Ç–æ –≤—ã–±–µ—Ä–µ—Ç?</h3>
            <div class="tt-badges" id="v-tt-magic"></div>
          </div>
          <div>
            <h3 class="block-title">üéß –ü–ª–µ–π–ª–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
            <div class="tracks" id="v-tracks"></div>
          </div>
        </div>

        <div class="mood">
          <h3 class="block-title">üñºÔ∏è –®–∫–æ–ª—å–Ω–∞—è —ç—Å—Ç–µ—Ç–∏–∫–∞</h3>
          <div class="mood-grid" id="v-moods"></div>
          <div class="chips" id="v-chips"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // –ü–∞—Ä—ã ¬´–ª–∏–±–æ/–ª–∏–±–æ¬ª
    const TT_AUTUMN = [
      {name:'tta1', a1:'–ñ—É—Ç–∫–æ–≤–∞—Ç–∞—è –æ—Å–µ–Ω—å', a2:'–£—é—Ç–Ω–∞—è –æ—Å–µ–Ω—å'},
      {name:'tta2', a1:'–¢—ã–∫–≤–µ–Ω–Ω—ã–π —Å–æ–∫', a2:'–ì–ª–∏–Ω—Ç–≤–µ–π–Ω'},
      {name:'tta3', a1:'–®—É–º –¥–æ–∂–¥—è', a2:'–¢—Ä–µ—Å–∫ –∫–∞–º–∏–Ω–∞'},
      {name:'tta4', a1:'–ó–∞–Ω–∏–º–∞—Ç—å—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ', a2:'–ß–∏—Ç–∞—Ç—å –≤–æ –¥–≤–æ—Ä–µ'},
      {name:'tta5', a1:'–í—ã—Ä–µ–∑–∞—Ç—å —Ç—ã–∫–≤—ã', a2:'–†–∞—Å–∫—Ä–∞—Å–∏—Ç—å —Ç—ã–∫–≤—ã'},
      {name:'tta6', a1:'–°–æ–±–∏—Ä–∞—Ç—å –∫–æ–Ω—Ñ–µ—Ç—ã', a2:'–°–∏–¥–µ—Ç—å —É –∫–æ—Å—Ç—Ä–∞'},
    ];
    const TT_MAGIC = [
      {name:'ttm1', a1:'–ú–∞–Ω—Ç–∏—è-–Ω–µ–≤–∏–¥–∏–º–∫–∞', a2:'–ö–∞—Ä—Ç–∞ –ú–∞—Ä–æ–¥—ë—Ä–æ–≤'},
      {name:'ttm2', a1:'–ú–µ—Ç–ª–∞', a2:'–ì–∏–ø–ø–æ–≥—Ä–∏—Ñ'},
      {name:'ttm3', a1:'–õ–µ–≤–∏—Ç–∞—Ü–∏—è', a2:'–ê–ø–ø–∞—Ä–∞—Ü–∏—è'},
      {name:'ttm4', a1:'–§–µ–ª–∏–∫—Å –§–µ–ª–∏—Ü–∏—Å', a2:'–û–º—É—Ç –ø–∞–º—è—Ç–∏'},
      {name:'ttm5', a1:'–ü–∞—Ç—Ä–æ–Ω—É—Å', a2:'–õ—é–º–æ—Å'},
      {name:'ttm6', a1:'–ó–µ–ª—å–µ–≤–∞—Ä–µ–Ω–∏–µ', a2:'–¢—Ä–∞–Ω—Å—Ñ–∏–≥—É—Ä–∞—Ü–∏—è'},
    ];

    // –ü–∞–ª–∏—Ç—Ä–∞
    function setPalette(p){
      document.body.classList.remove('gryff','rav','huff','sly');
      if(p) document.body.classList.add(p);
    }

    // –§–∞–π–ª—ã/URL -> dataURL; –≤–æ–∑–≤—Ä–∞—â–∞–µ–º {src, ok}
    function fileToDataURL(file){
      return new Promise((res, rej)=>{ if(!file) return res(null); const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
    }
    async function urlToDataURL(url){
      try{
        const resp = await fetch(url, {mode:'cors', credentials:'omit'});
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const blob = await resp.blob();
        return await new Promise((res, rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
      }catch(e){ return {__error:true, message:String(e)}; }
    }
    async function resolveImg(urlId, fileId, markEl){
      const f = document.getElementById(fileId)?.files?.[0];
      if (f) {
        markEl?.classList.remove('error');
        const src = await fileToDataURL(f);
        return {src, ok:true};
      }
      const url = (document.getElementById(urlId)?.value||'').trim();
      if (!url) { markEl?.classList.remove('error'); return {src:null, ok:true}; }
      const res = await urlToDataURL(url);
      if(res && res.__error){ markEl?.classList.add('error'); return {src:null, ok:false}; }
      markEl?.classList.remove('error'); return {src:res, ok:true};
    }
    function setImg(elId, src){ const el=document.getElementById(elId); el.src = src || ''; }

    // This-or-That helpers
    function readThisThat(pairs){
      const res = [];
      pairs.forEach(row=>{
        const checked = document.querySelector(`input[name="${row.name}"]:checked`);
        if(checked){ res.push(checked.value); }
      });
      return res;
    }
    function renderBadges(containerId, items){
      const wrap = document.getElementById(containerId);
      wrap.innerHTML='';
      if(!items.length){
        const span=document.createElement('span'); span.className='tt-badge'; span.textContent='‚Äî –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî';
        wrap.appendChild(span); return;
      }
      items.forEach(v=>{ const span=document.createElement('span'); span.className='tt-badge'; span.innerHTML=`<b>${v}</b>`; wrap.appendChild(span); });
    }

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –ø–ª–µ–π–ª–∏—Å—Ç–∞
    function rebuildTrackFields(){
      const n = Math.max(0, Math.min(12, parseInt(document.getElementById('tracksCount').value || '0', 10)));
      const cont = document.getElementById('tracksFields'); cont.innerHTML='';
      for(let i=1;i<=n;i++){
        const f1 = document.createElement('div'); f1.className='field';
        f1.innerHTML = `<label>–¢—Ä–µ–∫ ${i} (—Ç–µ–∫—Å—Ç)</label><input id="t${i}" value="">`;
        const f2 = document.createElement('div'); f2.className='field';
        f2.innerHTML = `<label>URL ${i}</label><input id="t${i}u" placeholder="https://...">`;
        cont.appendChild(f1); cont.appendChild(f2);
      }
    }
    function collectTracks(){
      const n = Math.max(0, Math.min(12, parseInt(document.getElementById('tracksCount').value || '0', 10)));
      const arr = [];
      for(let i=1;i<=n;i++){
        const text = (document.getElementById(`t${i}`)?.value)||'';
        const url  = (document.getElementById(`t${i}u`)?.value)||'';
        arr.push({text, url});
      }
      return arr;
    }
    function buildTracks(tracks){
      const wrap = document.getElementById('v-tracks'); wrap.innerHTML='';
      if(!tracks.length){ wrap.textContent='‚Äî –ø–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç ‚Äî'; return; }
      tracks.forEach((t,i)=>{
        const div=document.createElement('div'); div.className='track';
        const num = (i+1)+') ';
        if(t.text){
          if(t.url){
            const a=document.createElement('a'); a.href=t.url; a.target='_blank'; a.textContent=num + t.text; div.appendChild(a);
          } else { div.textContent = num + t.text; }
        } else { div.textContent = num + '‚Äî'; }
        wrap.appendChild(div);
      });
    }

    // –ì–ª–∞–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞
    async function buildCard(){
      const warn = document.getElementById('corsWarn');
      warn.style.display='none';

      // –ü–∞–ª–∏—Ç—Ä–∞
      setPalette(document.getElementById('palette').value);

      // –¢–µ–∫—Å—Ç—ã
      document.getElementById('v-name').textContent   = document.getElementById('name').value   || '–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞';
      document.getElementById('v-status').textContent = document.getElementById('status').value || '–ù–∏–∫/—Å—Ç–∞—Ç—É—Å';

      // –ê–≤–∞—Ç–∞—Ä
      let hadBad = false;
      {
        const r = await resolveImg('avaUrl','avaFile', document.getElementById('avaUrl'));
        if (!r.ok) hadBad = true;
        setImg('v-ava', r.src);
      }

      // This-or-That
      renderBadges('v-tt-autumn', readThisThat(TT_AUTUMN));
      renderBadges('v-tt-magic',  readThisThat(TT_MAGIC));

      // –¢—Ä–µ–∫–∏
      buildTracks(collectTracks());

      // –ú—É–¥–±–æ—Ä–¥ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–ª–æ—Ö–∏–µ URL)
      const moodWrap=document.getElementById('v-moods'); moodWrap.innerHTML='';
      for(let i=1;i<=6;i++){
        const urlEl=document.getElementById('m'+i+'u');
        const r = await resolveImg('m'+i+'u','m'+i+'f', urlEl);
        if (!r.ok) hadBad = true;
        if (r.src) { const im=document.createElement('img'); im.src=r.src; moodWrap.appendChild(im); }
      }

      // –ß–∏–ø—Å—ã
      const chipsWrap=document.getElementById('v-chips'); chipsWrap.innerHTML='';
      [
        {k:'–¶–≤–µ—Ç',v:document.getElementById('chipColor').value},
        {k:'–í–∫—É—Å',v:document.getElementById('chipTaste').value},
        {k:'–ó–∞–ø–∞—Ö',v:document.getElementById('chipSmell').value},
        {k:'–ó–≤—É–∫',v:document.getElementById('chipSound').value},
        {k:'–ü—Ä–µ–¥–º–µ—Ç',v:document.getElementById('chipItem').value},
      ].forEach(it=>{ if(!it.v) return; const span=document.createElement('span'); span.className='chip'; span.innerHTML='<b>'+it.k+':</b> '+it.v; chipsWrap.appendChild(span); });

      if (hadBad) warn.style.display='block';

      // >>> –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º PNG-–∫–Ω–æ–ø–∫—É
      enablePngBtn();
    }

    // PNG: –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä + –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    async function downloadPNG(){
      const node = document.getElementById('profileCard');

      async function tryRender(scale){
        return await html2canvas(node, {
          backgroundColor: null,
          useCORS: true,
          allowTaint: false,
          scale: scale,
          removeContainer: true,
          logging: false
        });
      }

function saveCanvas(canvas, filename){
  // 1) –ü—ã—Ç–∞–µ–º—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π download (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω sandbox'–æ–º)
  try {
    if (canvas.toBlob) {
      canvas.toBlob(function(blob){
        if(!blob){ return fallback(canvas); }
        const url = URL.createObjectURL(blob);

        // –ü—É—Ç—å 1: –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –≤ sandbox)
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        // –ï—Å–ª–∏ –ø–µ—Å–æ—á–Ω–∏—Ü–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ ‚Äî —É –Ω–∞—Å –≤—Å—ë —Ä–∞–≤–Ω–æ –µ—Å—Ç—å url, –∏–¥—ë–º —Ñ–æ–ª–±—ç–∫–æ–º
        setTimeout(()=>URL.revokeObjectURL(url), 5000);

        // –ù–µ–±–æ–ª—å—à–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å
        setTimeout(()=>maybeShowPreview(url, blob, filename), 300);
      }, 'image/png');
      return;
    }
  } catch(e) {
    console.warn('[png] download blocked, using fallback', e);
  }
  // 2) –§–æ–ª–±—ç–∫ —á–µ—Ä–µ–∑ dataURL
  fallback(canvas);

  function fallback(cnv){
    try{
      const data = cnv.toDataURL('image/png');
      // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Å–æ—á–Ω–∏—Ü—ã —Ä–∞–∑—Ä–µ—à–∞—é—Ç popups)
      const w = window.open(data, '_blank');
      if (!w) {
        // –ï—Å–ª–∏ –ø–æ–ø–∞–ø—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–∏–º –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ —Ñ–æ—Ä–º–æ–π
        maybeShowPreview(data, null, filename);
      }
    }catch(e){
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ—Ç–∫—Ä—ã—Ç—å PNG. –í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ –±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ.');
      console.error('[png] full fallback failed', e);
    }
  }

  // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é + –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ¬ª + ¬´–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä¬ª
  async function maybeShowPreview(urlOrData, blob, filename){
    let holder = document.getElementById('pngPreviewHolder');
    if (!holder){
      holder = document.createElement('div');
      holder.id = 'pngPreviewHolder';
      holder.style.marginTop = '10px';
      holder.style.padding = '10px';
      holder.style.border = '1px dashed var(--line)';
      holder.style.borderRadius = '12px';
      holder.innerHTML = '<div style="font-size:12px;opacity:.9;margin-bottom:6px">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø–µ—Å–æ—á–Ω–∏—Ü–µ–π. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:</div>';
      document.querySelector('.panel .btnbar').after(holder);
    }

    // –ö–∞—Ä—Ç–∏–Ω–∞
    let img = holder.querySelector('img');
    if(!img){
      img = document.createElement('img');
      img.style.maxWidth = '100%';
      img.style.borderRadius = '10px';
      img.style.display = 'block';
      img.style.marginBottom = '6px';
      holder.appendChild(img);
    }
    img.src = urlOrData;

    // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    let bar = holder.querySelector('.actions');
    if(!bar){
      bar = document.createElement('div');
      bar.className = 'actions';
      bar.style.display = 'flex';
      bar.style.gap = '8px';
      holder.appendChild(bar);

      const openBtn = document.createElement('button');
      openBtn.className = 'btn';
      openBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ';
      openBtn.onclick = ()=> window.open(urlOrData, '_blank');
      bar.appendChild(openBtn);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn';
      copyBtn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä';
      copyBtn.onclick = async ()=>{
        try{
          const b = blob || (await (await fetch(urlOrData)).blob());
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': b })]);
          copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì';
          setTimeout(()=>copyBtn.textContent='–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä', 1500);
        }catch(e){
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫.');
          console.error(e);
        }
      };
      bar.appendChild(copyBtn);
    }
  }
}


      const fname = (document.getElementById('name').value || 'anketa') + '.png';

      let canvas = null;
      try { canvas = await tryRender(2); } catch(e1){ console.warn('[png] scale 2 failed', e1); }
      if(!canvas){ try { canvas = await tryRender(1.5); } catch(e2){ console.warn('[png] scale 1.5 failed', e2); } }
      if(!canvas){ try { canvas = await tryRender(1); }   catch(e3){ console.warn('[png] scale 1 failed', e3); } }
      if(!canvas){
        alert('PNG –Ω–µ —Å–æ–±—Ä–∞–ª—Å—è. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –∏–ª–∏ –µ—Å—Ç—å —á—É–∂–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±–µ–∑ CORS. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–∞–º–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        return;
      }
      saveCanvas(canvas, fname);
    }

    // --- —Å–ª—É–∂–µ–±–Ω–æ–µ: –≤—Å–µ–≥–¥–∞ —Å–Ω—è—Ç—å disabled —Å –∫–Ω–æ–ø–∫–∏ PNG ---
    function enablePngBtn(){
      const btn = document.getElementById('pngBtn');
      if (btn) { btn.disabled = false; btn.removeAttribute('disabled'); }
    }
    if (document.readyState !== 'loading') enablePngBtn();
    else document.addEventListener('DOMContentLoaded', enablePngBtn);

    // –°–ª—É—à–∞—Ç–µ–ª–∏
    document.getElementById('tracksCount').addEventListener('input', ()=>{ rebuildTrackFields(); buildCard(); });
    document.getElementById('palette').addEventListener('change', ()=>{ setPalette(document.getElementById('palette').value); buildCard(); });
    document.getElementById('buildBtn').addEventListener('click', buildCard);
    document.getElementById('pngBtn').addEventListener('click', downloadPNG);

    // –ê–≤—Ç–æ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Ñ–æ—Ä–º–µ (—á—Ç–æ–±—ã –ø—Ä–µ–≤—å—é –∏ –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã)
    ['input','change'].forEach(ev=>{
      document.addEventListener(ev, e=>{
        if(e.target.closest('.panel')) buildCard();
      }, true);
    });

    // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
    rebuildTrackFields();
    buildCard();
  </script>
</body>
</html>